<!doctype html>
<html>
<head>
    <meta charset=utf-8>
    <link rel="icon shortcut" href=img/logo.png type=image/png>
    <link rel=apple-touch-icon href=img/logo.png>
    <link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css>
    <link rel=stylesheet href=css/base.css>
    <link rel=stylesheet href=css/home.css>
    <link rel=stylesheet href=css/ui-block.css>
    <meta name=viewport content="width=device-width">
    <title>星云链测试网 | Nebulas Testnet</title>
</head>
<body>
    <div class=logo-main></div>
    <div class=header></div>
    <div class=select-wallet-file></div>

    <div id="walletinfo" class="container transaction">
        <div class="col-md-8">
            <div class="form-group">
                <label for="address">Your Address</label>
                <input type="text" class="form-control" id="address" placeholder="" disabled>
            </div>
            <div class="form-group">
                <label for="keystore">Keystore File (UTC / JSON · Recommended · Encrypted)</label>
                <button type="submit" class="btn btn-default col-xs-12 col-sm-12 col-md-12 text-center" id="keystore">Download</button>
            </div>
            <div class="form-group">
                <label for="Privatekey">Private Key (unencrypted)</label>
                <input type="text" class="form-control" id="Privatekey" placeholder="" disabled>
            </div>
            <div class="col-md-12">
                <div class="col-md-6" style="text-align:center;">
                    <label for="addressqr">Your Address</label>
                    <div class="form-group" id="addressqr">
                    </div>
                </div>
                <div class="col-md-6" style="text-align:center;">
                    <label for="privateqr">Private Key (unencrypted)</label>
                    <div class="form-group" id="privateqr">
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="form-group">
                <label for="sideaddress">Account Address</label>
                <ul>
                    <li id="sideaddress" style="list-style-type:none;word-break:break-all;"></li>
                </ul>
            </div>
            <div class="form-group">
                <label for="amount">Account Balance</label>
                <ul>
                    <li id="amount" style="list-style-type:none;word-break:break-all;"></li>
                </ul>
            </div>
        </div>
    </div>

    <div class=footer></div>

    <div class="modal fade" tabindex="-1" id="info" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title">info</h4>
                </div>
                <div class="modal-body">
                    <p>unlocking&hellip;</p>
                </div>
            </div>
        </div>
    </div>

    <script src=https://code.jquery.com/jquery-3.3.1.slim.min.js></script>
    <script src=https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.bundle.min.js data-depends=jquery.slim></script>
    <script src=https://cdn.bootcss.com/bootbox.js/4.4.0/bootbox.min.js data-depends="bootstrap jquery"></script>
    <script src=js/Blob.js></script>
    <script src=js/FileSaver.min.js></script>
    <script src=js/home.v1.js></script>
    <script src=js/i18n.js data-depends=jquery.slim></script>
    <script src=js/jquery.qrcode.min.js data-depends=jquery></script>
    <script src=js/ui-block.js data-depends="bootbox jquery wallet.js"></script>
    <script src=js/wallet.js></script>
    <script>
        "use strict";

        var wallet = require("wallet"),
            Account = wallet.Account,
            Neb = wallet.Neb,
            Transaction = wallet.Transaction,
            Utils = wallet.Utils,
            neb = new Neb(),
            unitMap = {
                none: "0",
                nis: "1",
                knis: "1000",
                mnis: "1000000",
                nanonas: "1000000000",
                micronas: "1000000000000",
                millinas: "1000000000000000",
                nas: "1000000000000000000"
            },
            gAccount, gFileJson;

        neb.setRequest(new Neb.HttpRequest("https://testnet.nebulas.io"));
        $("#keystore").on("click", onClickKeystore);

        uiBlock({
            footer: ".footer",
            header: ".header",
            logoMain: ".logo-main",
            selectWalletFile: [".select-wallet-file", onUnlockFile]
        });

        function onUnlockFile(fileJson, account, password) {
            var state;

            try {
                gAccount = account;
                gFileJson = fileJson;
                account.fromKey(fileJson, password);

                $("#address").val(account.getAddressString());
                $("#sideaddress").text(account.getAddressString());
                $("#Privatekey").val(account.getPrivateKeyString());
                state = neb.api.getAccountState(account.getAddressString());

                $("#amount").text(Utils.toBigNumber(state.balance).dividedBy(unitValue("nas")).toNumber() + "  NAS");
                $("#addressqr").text("");
                $("#privateqr").text("");
                $("#addressqr").qrcode(account.getAddressString());
                $("#privateqr").qrcode(account.getPrivateKeyString());
                $("#walletinfo").show();
            } catch (e) {
                bootbox.dialog({
                    message: e,
                    size: "large",
                    title: "Error"
                });
            }
        }

        function unitValue(unit) {
            var unitValue = unitMap[(unit || "nas").toLowerCase()];

            if (unitValue === undefined)
                throw new Error("The unit undefined, please use the following units:" + JSON.stringify(unitMap, null, 2));

            return new Utils.toBigNumber(unitValue, 10);
        }

        function onClickKeystore() {
            var blob = new Blob([JSON.stringify(gFileJson)], { type: "application/json; charset=utf-8" });
            saveAs(blob, gAccount.getAddressString());
        }
    </script>
</body>
</html>